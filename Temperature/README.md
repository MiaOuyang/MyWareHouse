# 前言
- 软件版本
STM32CubeMX 6.4 0
Keil 531

- 硬件
STM32F103C8T6
# 1 I2C总线协议
## 1.1 I2C物理层
I2C通讯设备之间的常用连接方式

![在这里插入图片描述](https://img-blog.csdnimg.cn/4302877da60d4467a0c9938ea1daa52f.png)

它的物理层有如下特点：
1.  它是一个支持设备的总线。“总线”指多个设备共用的信号线。在一个I2C通讯总线中，可连接多个I2C通讯设备，支持多个通讯主机及多个通讯从机。
2.  一个I2C总线只使用两条总线线路，一条双向串行数据线(SDA) ，一条串行时钟线 (SCL)。数据线即用来表示数据，时钟线用于数据收发同步。
3.  每个连接到总线的设备都有一个独立的地址，主机可以利用这个地址进行不同设备之间的访问。
4.  总线通过上拉电阻接到电源。当I2C设备空闲时，会输出高阻态，而当所有设备都空闲，都输出高阻态时，由上拉电阻把总线拉成高电平。
5.  多个主机同时使用总线时，为了防止数据冲突，会利用仲裁方式决定由哪个设备占用总线。
6. 具有三种传输模式：标准模式传输速率为100kbit/s ，快速模式为400kbit/s ，高速模式下可达 3.4Mbit/s，但目前大多I2C设备尚不支持高速模式。
7. 连接到相同总线的 IC 数量受到总线的最大电容 400pF 限制 。

## 1.2 I2C时序介绍
1. 空闲状态
当总线上的SDA和SCL两条信号线同时处于高电平,便是空闲状态,如上面的硬件图所示,当我们不传输数据时, SDA和SCL被上拉电阻拉高,即进入空闲状态

2. 起始信号
当SCL为高期间，SDA由高到低的跳变；便是总线的启动信号,只能由主机发起,且在空闲状态下才能启动该信号,如下图所示：
![在这里插入图片描述](https://img-blog.csdnimg.cn/b129a7497ea3422896dd0c9485345b9b.png)
3. 停止信号
当SCL为高期间，SDA由低到高的跳变；便是总线的停止信号,表示数据已传输完成。
4. 传输数据格式
当发了起始信号后，就开始传输数据，传输的数据格式如下图所示：
当SCL为高电平时，便会获取SDA数据值，其中SDA数据必须是稳定的(若SDA不稳定就会变成起始/停止信号)。
当SCL为低电平时，便是SDA的电平变化状态。
若主从机在传输数据期间，需要完成其它功能(例如一个中断)，可以主动拉低SCL，使I2C进入等待状态，直到处理结束再释放SCL，数据传输会继续。
![在这里插入图片描述](https://img-blog.csdnimg.cn/b5c617aa416646c68c339ac2fbdfb39b.png)
5. 应答信号ACK
I2C总线上的数据都是以8位数据(字节)进行的，当发送了8个数据后，发送方会在第9个时钟脉冲期间释放SDA数据，当接收方接收该字节成功，便会输出一个ACK应答信号，当SDA为高电平，表示为非应答信号NACK，当SDA为低电平，表示为有效应答信号ACK。
PS:当主机为接收方时,收到最后一个字节后,主机可以不发送ACK，直接发送停止信号来结束传输。
当从机为接收方时，没有发送ACK，则表示从机可能在忙其它事、或者不匹配地址信号和不支持多主机发送，主机可以发送停止信号，再次发送起始信号启动新的传输。
![在这里插入图片描述](https://img-blog.csdnimg.cn/cf318c2a7ce3422aaaefcfac5ea374db.png)
I2C总线上的每个设备都有自己的独立地址，主机发起通讯时，通过SDA信号线发送设备地址(SLAVE_ADDRESS)来查找从机。I2C协议规定设备地址可以是7位或10位，实际中7位的地址应用比较广泛。紧跟设备地址的一个数据位用来表示数据传输方向，它是数据方向位(R/W)，第8位或第11位。数据方向位为“1”时表示主机由从机读数据，该位为“0”时表示主机向从机写数据。
![在这里插入图片描述](https://img-blog.csdnimg.cn/71aaec2af3bb4e9e8a230389f404c9a6.png)
读数据方向时，主机会释放对SDA信号线的控制，由从机控制SDA信号线，主机接收信号，写数据方向时，SDA由主机控制，从机接收信号。
## 1.3 IIC传输数据的格式
1. 写操作
刚开始主芯片要发出一个start信号，然后发出一个(用来确定是往哪一个芯片写数据)，方向(读/写，0表示写，1表示读)。回应(用来确定这个设备是否存在)，然后就可以传输数据，传输数据之后，要有一个回应信号（确定数据是否接受完成)，然后再传输下一个数据。每传输一个数据，接受方都会有一个回应信号，数据发送完之后，主芯片就会发送一个停止信号。
![在这里插入图片描述](https://img-blog.csdnimg.cn/728d35ece0764082bea479a08a88a2f1.png)
2. 读操作
刚开始主芯片要发出一个start信号，然后发出一个设备地址(用来确定是从哪一个芯片读取数据)，方向(读/写，0表示写，1表示读)。回应(用来确定这个设备是否存在)，然后就可以传输数据，传输数据之后，要有一个回应信号（确定数据是否接受完成)，然后在传输下一个数据。每传输一个数据，接受方都会有一个回应信号，数据发送完之后，主芯片就会发送一个停止信号。
![在这里插入图片描述](https://img-blog.csdnimg.cn/de8b4ab343c746ee832fe24cd82b331f.png)
